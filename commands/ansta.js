const axios = require('axios');

module.exports = async ({ sock, msg, text, reply, from }) => {
  if (!text.startsWith('insta') && !text.startsWith('ig')) return;

  const parts = text.trim().split(' ');
  if (parts.length < 2) {
    return reply('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ø¥Ù†Ø³ØªØºØ±Ø§Ù….\nÙ…Ø«Ø§Ù„: insta https://www.instagram.com/reel/...');
  }

  const instaUrl = parts[1];

  if (!instaUrl.includes('instagram.com')) {
    return reply('âŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ù†Ø³ØªØºØ±Ø§Ù… ØµØ­ÙŠØ­.');
  }

  try {
    await sock.sendMessage(from, { react: { text: 'â³', key: msg.key } });

    // ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¬Ø§Ù†ÙŠØ© (ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø§Ø­Ù‚Ù‹Ø§)
    const apiUrl = `https://api.nexoracle.com/downloader/instagram?apikey=free_key@maher_apis&url=${encodeURIComponent(instaUrl)}`;
    const response = await axios.get(apiUrl);

    if (!response.data || response.data.status !== 200 || !response.data.result || !response.data.result.url) {
      return reply('âŒ ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø¬Ø±Ø¨ Ù„Ø§Ø­Ù‚Ù‹Ø§.');
    }

    const videoUrl = response.data.result.url;

    await reply(`ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ Ø¥Ù†Ø³ØªØºØ±Ø§Ù… ... Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.`);

    const videoResponse = await axios.get(videoUrl, { responseType: 'arraybuffer' });
    const videoBuffer = Buffer.from(videoResponse.data, 'binary');

    await sock.sendMessage(from, {
      video: videoBuffer,
      caption: `ğŸ“¥ ÙÙŠØ¯ÙŠÙˆ Instagram\n\nâœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø·Ù€Ù€Ù€Ù€Ù€Ø±Ø²Ø§Ù† Ø§Ù„ÙˆØ§Ù‚Ø¯ÙŠ`,
    }, { quoted: msg });

    await sock.sendMessage(from, { react: { text: 'âœ…', key: msg.key } });

  } catch (error) {
    console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ Instagram:', error);
    await reply('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.');
    await sock.sendMessage(from, { react: { text: 'âŒ', key: msg.key } });
  }
};
